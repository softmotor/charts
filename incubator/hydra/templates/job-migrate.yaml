{{- if or .Release.IsInstall (and .Release.IsUpgrade .Values.migrateSQL) -}}
apiVersion: "batch/v1"
kind: "Job"
metadata:
  name: "{{ template "hydra.fullname" . }}-migrate-{{ .Release.Revision }}"
  labels:
    app: "{{ template "hydra.fullname" . }}"
  annotations:
  {{- if .Values.migrateSQL }}
    "helm.sh/hook": "post-install,post-upgrade"
  {{- else }}
    "helm.sh/hook": "post-install"
  {{- end }}
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "hook-succeeded"
spec:
  backoffLimit: 3
  activeDeadlineSeconds: 120
  template:
    spec:
      initContainers:
      - name: "wait-postgresql"
        image: "postgres:{{ .Values.postgresql.imageTag }}"
        command:
        - "sh"
        - "-c"
        - "until (exec pg_isready -d {{ include "hydra.databaseURL" . | b64dec }}) 2>&1; do sleep 2; done;"
      containers:
      - name: "hydra-migrate"
        image: {{ printf "%s:%s" .Values.image .Values.imageTag | quote }}
        command: ["hydra"]
        args: ["migrate", "sql", "$(DATABASE_URL)"]
        envFrom:
        - secretRef:
            name: {{ template "hydra.fullname" . }}
            optional: false
      restartPolicy: "Never"
{{- end -}}
